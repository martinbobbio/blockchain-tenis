# Ganache seed --> 777
from random import randrange
from web3 import Web3
import matplotlib.pyplot as plt
import sys
import names
#Connection to ganache-cli
w3 = Web3(Web3.HTTPProvider('http://localhost:8545'))
#Address (Organizador del torneo)
address = w3.eth.accounts[0]
#Clave privada generada
private_key = '0x89509d53cb5b39a7d275cc446d3df34cfd31dfb5f39ca2e109a50eecf69a4d6f'
#Byte del contrato
byteCode = '0x' + '608060405234801561001057600080fd5b50610fcd806100206000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c8063085fa69a146100675780631ace5d86146100f05780631da120c0146102a75780631e09dac8146104a4578063cd61386d146104dc578063d60fa690146104fa575b600080fd5b6100ee600480360361014081101561007e57600080fd5b810190808035906020019092919080359060200190929190803590602001909291908035906020019092919080359060200190929190803590602001909291908035906020019092919080359060200190929190803590602001909291908035906020019092919050505061055a565b005b61011c6004803603602081101561010657600080fd5b8101908080359060200190929190505050610762565b60405180806020018c815260200180602001806020018b81526020018a815260200189815260200188815260200187815260200186815260200185815260200184810384528f818151815260200191508051906020019080838360005b83811015610194578082015181840152602081019050610179565b50505050905090810190601f1680156101c15780820380516001836020036101000a031916815260200191505b5084810383528d818151815260200191508051906020019080838360005b838110156101fa5780820151818401526020810190506101df565b50505050905090810190601f1680156102275780820380516001836020036101000a031916815260200191505b5084810382528c818151815260200191508051906020019080838360005b83811015610260578082015181840152602081019050610245565b50505050905090810190601f16801561028d5780820380516001836020036101000a031916815260200191505b509e50505050505050505050505050505060405180910390f35b6104a2600480360360a08110156102bd57600080fd5b8101908080359060200190929190803590602001906401000000008111156102e457600080fd5b8201836020820111156102f657600080fd5b8035906020019184600183028401116401000000008311171561031857600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290803590602001909291908035906020019064010000000081111561038557600080fd5b82018360208201111561039757600080fd5b803590602001918460018302840111640100000000831117156103b957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192908035906020019064010000000081111561041c57600080fd5b82018360208201111561042e57600080fd5b8035906020019184600183028401116401000000008311171561045057600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506109b7565b005b6104da600480360360408110156104ba57600080fd5b810190808035906020019092919080359060200190929190505050610a7c565b005b6104e4610b64565b6040518082815260200191505060405180910390f35b610558600480360360c081101561051057600080fd5b81019080803590602001909291908035906020019092919080359060200190929190803590602001909291908035906020019092919080359060200190929190505050610b71565b005b6105638a610ce9565b61056c85610ce9565b6105768a86610d83565b60016000808c815260200190815260200160002060040160008282540192505081905550886000808c815260200190815260200160002060070160008282540192505081905550876000808c815260200190815260200160002060080160008282540192505081905550866000808c815260200190815260200160002060090160008282540192505081905550856000808c8152602001908152602001600020600a016000828254019250508190555061064460008087815260200190815260200160002060060154610de0565b6000808c81526020019081526020016000206006016000828254019250508190555060016000808781526020019081526020016000206005016000828254019250508190555083600080878152602001908152602001600020600701600082825401925050819055508260008087815260200190815260200160002060080160008282540192505081905550816000808781526020019081526020016000206009016000828254019250508190555080600080878152602001908152602001600020600a016000828254019250508190555061073460008087815260200190815260200160002060060154610de0565b6000808781526020019081526020016000206006016000828254039250508190555050505050505050505050565b606060006060806000806000806000806000806000808e8152602001908152602001600020905080600001816001015482600201836003018460040154856005015486600601548760070154886008015489600901548a600a01548a8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108525780601f1061082757610100808354040283529160200191610852565b820191906000526020600020905b81548152906001019060200180831161083557829003601f168201915b50505050509a50888054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108ee5780601f106108c3576101008083540402835291602001916108ee565b820191906000526020600020905b8154815290600101906020018083116108d157829003601f168201915b50505050509850878054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561098a5780601f1061095f5761010080835404028352916020019161098a565b820191906000526020600020905b81548152906001019060200180831161096d57829003601f168201915b505050505097509b509b509b509b509b509b509b509b509b509b509b505091939597999b90929496989a50565b6109c085610df4565b60008060008781526020019081526020016000209050848160000190805190602001906109ee929190610e88565b5083816001018190555081816003019080519060200190610a10929190610e88565b5082816002019080519060200190610a29929190610e88565b506000816004018190555060008160050181905550606481600601819055506001869080600181540180825580915050906001820390600052602060002001600090919290919091505550505050505050565b610a8582610ce9565b610a8e81610ce9565b610a988282610d83565b600160008084815260200190815260200160002060040160008282540192505081905550610ada60008083815260200190815260200160002060060154610de0565b60008084815260200190815260200160002060060160008282540192505081905550600160008083815260200190815260200160002060050160008282540192505081905550610b3e60008083815260200190815260200160002060060154610de0565b600080838152602001908152602001600020600601600082825403925050819055505050565b6000600180549050905090565b610b7a86610ce9565b610b8383610ce9565b610b8d8684610d83565b60016000808881526020019081526020016000206004016000828254019250508190555084600080888152602001908152602001600020600701600082825401925050819055508360008088815260200190815260200160002060080160008282540192505081905550610c1560008085815260200190815260200160002060060154610de0565b6000808881526020019081526020016000206006016000828254019250508190555060016000808581526020019081526020016000206005016000828254019250508190555081600080858152602001908152602001600020600701600082825401925050819055508060008085815260200190815260200160002060080160008282540192505081905550610cbf60008085815260200190815260200160002060060154610de0565b60008085815260200190815260200160002060060160008282540392505081905550505050505050565b60008090505b600180549050811015610d2e578160018281548110610d0a57fe5b90600052602060002001541415610d215750610d80565b8080600101915050610cef565b506040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526022815260200180610f2e6022913960400191505060405180910390fd5b50565b80821415610ddc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526023815260200180610f506023913960400191505060405180910390fd5b5050565b6000600a8281610dec57fe5b059050919050565b60008090505b600180549050811015610e84578160018281548110610e1557fe5b90600052602060002001541415610e77576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180610f736026913960400191505060405180910390fd5b8080600101915050610dfa565b5050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ec957805160ff1916838001178555610ef7565b82800160010185558215610ef7579182015b82811115610ef6578251825591602001919060010190610edb565b5b509050610f049190610f08565b5090565b610f2a91905b80821115610f26576000816000905550600101610f0e565b5090565b9056fe4964206e6f74206578697374732c20747279207769746820616e6f746865722069644964732061726520657175616c732c207472792077697468206f746865727320696473496420616c7265616479206578697374732c20747279207769746820616e6f74686572206964a265627a7a723158201743da366f6810b20a6874aa0f446386d31514a22e06e2599a4f098652c5d89a64736f6c63430005110032'
#Abi del contrato
abi = '[{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":true,"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"getPlayerById","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"int256","name":"","type":"int256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getPlayersLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"age","type":"uint256"},{"internalType":"string","name":"skill_hand","type":"string"},{"internalType":"string","name":"backhand_type","type":"string"}],"name":"registerPlayer","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"player_win_id","type":"uint256"},{"internalType":"uint256","name":"player_win_aces","type":"uint256"},{"internalType":"uint256","name":"player_win_winners","type":"uint256"},{"internalType":"uint256","name":"player_win_double_faults","type":"uint256"},{"internalType":"uint256","name":"player_win_unforce_error","type":"uint256"},{"internalType":"uint256","name":"player_loss_id","type":"uint256"},{"internalType":"uint256","name":"player_loss_aces","type":"uint256"},{"internalType":"uint256","name":"player_loss_winners","type":"uint256"},{"internalType":"uint256","name":"player_loss_double_faults","type":"uint256"},{"internalType":"uint256","name":"player_loss_unforce_error","type":"uint256"}],"name":"setMatchAdvanced","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"player_win_id","type":"uint256"},{"internalType":"uint256","name":"player_loss_id","type":"uint256"}],"name":"setMatchBasic","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"player_win_id","type":"uint256"},{"internalType":"uint256","name":"player_win_aces","type":"uint256"},{"internalType":"uint256","name":"player_win_winners","type":"uint256"},{"internalType":"uint256","name":"player_loss_id","type":"uint256"},{"internalType":"uint256","name":"player_loss_aces","type":"uint256"},{"internalType":"uint256","name":"player_loss_winners","type":"uint256"}],"name":"setMatchIntermediate","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]'

count_matchs = 10
count_players = 20
players = []

if(sys.argv[1]):
    arg_array = sys.argv[1].strip('--').split('=')
    if arg_array[0] == 'matchs': count_matchs = int(arg_array[1])
    if arg_array[0] == 'players': count_players = int(arg_array[1])

if(sys.argv[2]):
    arg_array = sys.argv[2].strip('--').split('=')
    if arg_array[0] == 'matchs': count_matchs = int(arg_array[1])
    if arg_array[0] == 'players': count_players = int(arg_array[1])

#Config SmartContract
configContract = dict(
    nonce = w3.eth.getTransactionCount(address),
    gasPrice = w3.eth.gasPrice,
    gas = w3.eth.estimateGas(dict(data = byteCode)),
    data = byteCode
)

signed = w3.eth.account.sign_transaction(configContract, private_key)
transaction = w3.eth.sendRawTransaction(signed.rawTransaction)

contract_address = w3.toChecksumAddress('0x4bb0ec90ce7d606059eb0ee2f09e979efd1e6345')
smartContract = w3.eth.contract(address=contract_address, abi=abi)

def getRandomPlayers():
    name = names.get_full_name(gender='male')
    age = randrange(18, 45)
    hand = 'Derecho'
    backhand_type = 'Revés a dos manos'
    identificator = smartContract.functions.getPlayersLength().call()
    if randrange(3) == 2: hand = 'Zurdo'
    if randrange(3) == 2: backhand_type = 'Revés a una mano'
    return (identificator, name, age, hand, backhand_type)

def getRandomStats():
    count = smartContract.functions.getPlayersLength().call()
    id_win = randrange(0, count)
    id_loss = randrange(0, count)
    while id_win is id_loss: id_loss = randrange(0, count)
    return (id_win,randrange(10), randrange(20), randrange(5), randrange(8), 
    id_loss, randrange(5), randrange(10), randrange(10), randrange(16))

def initSimulation():
    for p in range(count_players):
        p = getRandomPlayers()
        smartContract.functions.registerPlayer(*p).transact({'from' : address})
        p = smartContract.functions.getPlayerById(p[0]).call()
        players.append(p)
        print("Se cargo el jugador a la blockchain:",p[0],'con',p[1],'años de edad y es', p[2])
        
    for m in range(count_matchs):
        m = getRandomStats()
        winner = smartContract.functions.getPlayerById(m[0]).call()[0]
        losser = smartContract.functions.getPlayerById(m[5]).call()[0]
        smartContract.functions.setMatchAdvanced(*m).transact({'from' : address})
        print("Se cargo el partido a la blockchain:",winner,"(",m[1],"aces /",m[2],"winners /",m[3],"dobles faltas /",m[4],"errores no forzados)","le ganó a",losser,"(",m[6],"aces /",m[7],"winners /",m[8],"dobles faltas /",m[9],"errores no forzados)")

def loadPlayers():
    players = []
    for p in range(count_players):
        p = smartContract.functions.getPlayerById(p).call()
        players.append(p)
    return players

def checkTournaments():
    players = loadPlayers()
    tournaments = [
        {"name":"Torneo pequeño","min_points":50,"max_points":75},
        {"name":"Torneo para experimentados","min_points":75,"max_points":100},
        {"name":"Gran Torneo","min_points":100,"max_points":150},
    ]
    for t in tournaments:
        for p in players:
            p[6]
            print("{} tiene {}".format(p[0], p[6]))
            print("El torneo requiere minimo {} y {} para competir".format(t["min_points"], t["max_points"]))
            if t["min_points"] <= p[6] <= t["max_points"]: print("Tiene permitido jugarlo")
            else: print("No tiene permitido jugarlo")


def showStats():
    players = loadPlayers()
    total_players = smartContract.functions.getPlayersLength().call()
    print("Jugadores totales:", total_players)

    labels = 'Aces', 'Winners', 'Double faults', 'Unforced errors'
    plt.figure('Métricas')
    plt.subplot(421)
    plt.title("{} (W:{},L:{},P:{})".format(players[0][0],players[0][4],players[0][5],players[0][6]))
    sizes = [players[0][7], players[0][8], players[0][9], players[0][10]]
    plt.pie(sizes, labels=labels, autopct='%1.0f')
    plt.subplot(424)
    plt.title("{} (W:{},L:{},P:{})".format(players[1][0],players[1][4],players[1][5],players[1][6]))
    sizes = [players[1][7], players[1][8], players[1][9], players[1][10]]
    plt.pie(sizes, labels=labels, autopct='%1.0f')
    plt.subplot(425)
    plt.title("{} (W:{},L:{},P:{})".format(players[2][0],players[2][4],players[2][5],players[2][6]))
    sizes = [players[2][7], players[2][8], players[2][9], players[2][10]]
    plt.pie(sizes, labels=labels, autopct='%1.0f')
    plt.subplot(428)
    plt.title("{} (W:{},L:{},P:{})".format(players[3][0],players[3][4],players[3][5],players[3][6]))
    sizes = [players[3][7], players[3][8], players[3][9], players[3][10]]
    plt.pie(sizes, labels=labels, autopct='%1.0f')

    plt.show()


initSimulation()
checkTournaments()
showStats()